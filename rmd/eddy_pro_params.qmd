---
title: "Eddy Pro Parameters 3m Tower"
author: "Alex Cebulski"
format: html
---

## Overview

Find the parameters we need for the eddy pro metadata file and output these as a html doc.

:::{.callout-important}
## Caution
Tower raised at 5 pm Feb 17 (MST) aka 6 pm CDT / MDT
:::

# PROJECT CREATION 

## Logger Frequency

```{r}
# library(tidyverse)
# ecHF1_low <- readRDS('../data/TOA5_FRG_low_20220214.highfreq.rds')
# 
# ecHF_head <- head(ecHF1_low, n = 25)
# saveRDS(ecHF_head, '../data/example_TOA5_FRG_low_20220214.highfreq.rds')
ec_hf_head <- readRDS('../data/example_TOA5_FRG_low_20220214.highfreq.rds')

ec_hf_head
```

Manually checked and is ~20hz.

Cols are:

- V
- W
- U
- Ts (sonic temperature)
- vh (mV, ??)
- diag_word (diagnostic word)

## Find Canopy Height

Load Data:

```{r}
tree_heights <- readRDS('../../lidar/data/22_243_FT_ttops_5m_norm.rds')
mean_height <- mean(tree_heights$Z)
```

The average tree height of the small bounding box around the tall tower is: `r mean_height` m.

## Displacement Height and Roughness Length

```{r}
readRDS('../data/average_z_0m_d0_2m_3m.rds')
```

## Find Station Coords

```{r}
coords <- read.csv('../../../research/data/gis/site_coords.csv')  

coords$lon_dms <- sp::dd2dms(coords$lon) |> as.character()
coords$lat_dms <- sp::dd2dms(coords$lat, NS = T) |> as.character()

```

The rough coordinates of Fortress Mountain are: 

`r coords[3,]`

## Angle From North

North offset from https://www.licor.com/env/support/EddyPro/topics/north-offset.html

    For post-mounted anemometers (e.g., Gill WindMaster® and Metek USA-1), a tag is normally provided to align the anemometer correctly with respect to due north. The anemometer, however, can be placed in any position. If it is positioned with the north arrow aligned off of north, the yaw offset must be measured and provided here. The offset angle should be provided in degrees past north as a positive value representing the angle from geographic north (from an overhead view, degrees past north are in the clockwise direction). Yoke-mounted anemometers (Gill HS and Campbell® Scientific CSAT3) are normally oriented facing the prevailing wind direction and independently of due north. In these cases, provide the angle between the main axis of the anemometer (pointing away from the support arm) and due north, with the same sign convention as with vertical mounted anemometers.

Measured Eddie covariance lower tower direction using Suunto compass with 18° declination. on june 29 2022.
Compass reads 120° using the box pointing through the claws.

Confirmed again on Aug 23, 2023, using Iphone compass with true north selected on which read 126 deg.. very close to the suunto compass below. 


```{r}
ec_direction_raw <- 120 # using suunto compass with 18 deg declination
suunto_declination <- 18 # from compass for Vancouver 2018
calg_declination <- 14 # for calgary from https://www.ncei.noaa.gov/maps/historical_declination/
dir_mag_raw <- ec_direction_raw + suunto_declination
ec_dir_final <- dir_mag_raw - calg_declination 
```

The North Offset is:

`r ec_dir_final`°

## Instrument Separation

Feb. 17 2022 measurement
estimated using iphone image. need to double check with in-situ measurement.

- northward separation: 8 cm
- eastward separation: 4 cm

Aug 23, 2023 measurement 

using iphone compass measured 18 cm separation between csat claws and kh20 path on a line 25 deg from north.

$$
Sin\theta = \frac{Opp}{Hyp}
$$
$$
Cos\theta = \frac{Adj}{Hyp}
$$
where $Hyp$ is the distance we measured, $Opp$ is the eastward separation, and $Adj$ is the northward separation. 

```{r}
inst_sep <- 18 # cm, the hypotenuse of the triangle 
inst_deg <- 25 # deg from north, the angle between the adjacent and hypotenuse legs of the triangle
inst_rad <- 25 * (pi  / 180)

north_sep <- cos(inst_rad) * inst_sep
east_sep <- sin(inst_rad) * inst_sep
```

The northward separation is `north_sep` (cm) and the eastward separation is `east_sep` (cm).

Path Length (KH20)

see 'docs/ATTEMA-THESIS-2020.pdf'

- longitudinal: 1.25
- tranversal: 1

## Time Lag

Const SCAN_INTERVAL = 50 ' (100mSec) is this response time ?? (1/0.05 == 20 hz)
Const CSAT_OPT = 20 '(10) - this tells the CSAT what freq. to expect a trigger
Const ANALOG_DELAY = 6 '6 scan delay (4(3 scan delay)) - delay for non-csat flux instruments eg. KH20, FWTC etc.
Const CSAT_DELAY = 4 '(4 scan delay (2(1 scan delay)) - delay for CSAT to match the analog delay... pipeline delay of 2 scans is done automatically by SDM

## Hydrometer Specs

Model: KH20
Serial: SN1528 
Const XKW_high = -0.181 'sensor specific S/N 1527, scaled, dry vapour range
Const Cp_high = 1005 'approximate heat capacity of air
Const LV_high = 2835 'approx. latent heat of sublimation at 0C
Const RHO_high = 1.204 ' estimate air density
Const x = 1  ' Path length of KH20 (cm)
Const xkw = (-1) * x * XKW_high  'Path Length * Water Vapor absorbtion coefficient (M^3 / g)
Public rho_w
Units rho_w = g/m^3

Unknown but requried

Software version of csat and kh20
serial num for csat3
Response time of kh20 ??

:::{.callout-note}
## Note
These metadata are from the SnowExp_CSAT_high_R1.CR3 program
:::

## BASIC SETTINGS

TOB1_FRG_low_20220214.highfreq_yyyy_mm_dd_HHMM.dat