---
title: "Fortress Forest Wind Profile"
author: "Cebulski, A.C"
date: "`r Sys.Date()`"
output: html_document
bibliography: [../../papers/bibtex/library.bib]
csl: ../../papers/bibtex/apa.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r pkgs}
library(tidyverse)
library(trbtransfeR)
```

Return wind profile as in 836 assignment 4. feb14 - mar 4 US wind suspect.

TODO: 
- lower EC was raised feb 2022 need to fix in QAQC before applying across all dates
- what is the difference in  "horiz_wind_spd" & "result_wind_spd"
- how does this change over time? 

## Functions 

This script is based on this: 

$$
\overline{u} = \frac{u_*}{K} ln(\frac{z - d_0}{z_0})
$$

where $\overline{u}$ is average wind speed, $u_*$ is the friction velocity, $z$ is the instrument height, $d_0$ is the displacement height, $z_0$ is the roughness length of momentum for an average canopy-top height, and $k$ is the von Karmen Constant. See @Stull2017 page  677 or @Shuttleworth2012 page 286. 

```{r, include=F}
# load ####

low_wind <- readRDS('data/eddy_cov_15min_combined.rds') |> select(TIMESTAMP, u_star, low_ec_rslt_wnd_spd = result_wind_spd)# |> 
#   pivot_longer(u_star:low_ec_rslt_wnd_spd)
# 
# ggplot(low_wind, aes(TIMESTAMP, value, colour = name)) + geom_line()
# 
# plotly::ggplotly()

mid_hi_wind <- readRDS('../../analysis/treefort-main/data/met/met_main.rds') |> select(TIMESTAMP, USWindSpeed_S_WVT, top_ec_rlst_wnd_spd, top_ec_u_star)

wind_wide <- left_join(low_wind, mid_hi_wind, by = 'TIMESTAMP')
 
wnd <- left_join(low_wind, mid_hi_wind, by = 'TIMESTAMP') |> 
  pivot_longer(low_ec_rslt_wnd_spd:top_ec_rlst_wnd_spd)

ggplot(wnd, aes(TIMESTAMP, value, colour = name, group = name)) +
  geom_point()

plotly::ggplotly()

# jan 16 looks good, confirmed no new snow with wingscape camera

jan16 <- wnd |> filter(TIMESTAMP == as.POSIXct('2022-01-16 16:00:00', tz = 'CST'))

# calculate instument heights (rough using lidar and measured SR50 height)
sr50_ht <- 2.65
cup <- 2083.757
sr50_rel_ht <- 2082.255
us_rel_ht <- cup - sr50_rel_ht
us_ht <- sr50_ht +  us_rel_ht
ec_top_asl <- 2093.151 
ec_top_rel <- ec_top_asl - sr50_rel_ht
ec_top <- ec_top_rel + sr50_ht

jan16$height <- c(2, us_ht, ec_top)

# plot measured ####
ggplot(jan16) +
  aes(value, height) +
  geom_point()
```

## Explore Friction Velocity with wind speed and instrument height / type 

```{r}
jan16day <- wind_wide |> filter(as.Date(TIMESTAMP) == as.Date('2022-01-16')) |> 
  select(TIMESTAMP, u_star, top_ec_u_star) |> 
  pivot_longer(u_star:top_ec_u_star)

ggplot(jan16day, aes(TIMESTAMP, value, colour = name)) +
  geom_point()
```

```{r}
low <- wind_wide |> 
  select(TIMESTAMP, u_star, wind_speed = low_ec_rslt_wnd_spd) |> 
  mutate(group = '3 m')

hi <- wind_wide |> 
  select(TIMESTAMP, u_star = top_ec_u_star, wind_speed = top_ec_rlst_wnd_spd) |> 
  mutate(group = '13.5 m')

all <- rbind(low, hi) |> filter(as.Date(TIMESTAMP) == as.Date('2022-01-16')) 

ggplot(all, aes(wind_speed, u_star, colour = group)) +
  geom_point()
```


## Simulated Wind Curve

```{r}
# simulated wind curve ####

# estimate wind profile from 2 - 13.5 m, do not supply u_star as it needs to be estimated as average/integration over the profile
est_pars <- trbtransfeR::optim_wind_params(uMeas = jan16$value, 
                                       zHeight = jan16$height, 
                                       u_star = NA,
                                       z_0m = NA,
                                       d_0 = NA
                                       )

est_pars
est_pars_long <- est_pars |> pivot_longer(everything())

mod_df <- data.frame(height_m = seq(est_pars$d_0+est_pars$z_0m, 25, 0.1))

mod_df$value <- trbtransfeR::fit_neutral_wind_helpr(c(est_pars$ustar, est_pars$z_0m, est_pars$d_0), mod_df$height_m)
mod_df$group <- 'simulated'

jan16fltr <- jan16 |> select(height_m = height, value) |> mutate(group = 'obs') |> as.data.frame()

ggplot(rbind(mod_df, jan16fltr)) +
  aes(value, height_m, colour = group) +
  geom_point()

all <- rbind(mod_df, jan16fltr)

ggplot(data = all, aes(value, height_m, colour = group)) +
  geom_line(data = subset(all, group == 'simulated')) +
  geom_point(data = subset(all, group == 'obs')) +
  annotation_custom(gridExtra::tableGrob(est_pars_long), xmin = 0, ymin = 15)

ggsave('figs/FFR_wind_profile.png', height = 5, width = 5)
```  

## Results
The modelled wind speed parameters are representative of the overall wind speed profile and not reflective of a single measurement height. 

- The fitted wind curve for Jan 16 4 pm results in an **estimated** $u_*$ value of: `r round(est_pars$ustar, 3)` 
- The **measured** $u_*$ on this day at 3m height is: `r round(unique(jan16$u_star), 3)`
- The **measured** $u_*$ on this day at 14m height is: `r round(unique(jan16$top_ec_u_star), 3)`

The $u_*$ measured at 3 m is very close to modelled. This is likely becuase the 3 m wind speed is a better representation of the averge while the top tower u_star value is skewed.