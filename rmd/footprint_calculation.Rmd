---
title: "Footprint Calculation"
author: "Cebulski, A.C"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(weatherdash)
```

:::{.callout-important}
## Note:
Some constants are calculated in the eddy_pro_params.qmd file.
:::

TODO:

- lower EC was raised winter 2022 need to fix in QAQC before applying across all dates
- instrument height changes relative to snow calculate using SR50 data? 
- footprint in adams script Klujn footprinting method (https://footprint.kljun.net/)
Two Scripts (R; Python; Matlab):
calc_footprint_FFP (calculates footprint for each half-hour (or timestep))
Gets distances from which you can filter out the fluxes (we use distance away from tower at the 80% flux for [N, NE, E, SE, S, SW, W, NW])
To estimate distances available for us we just use measuring on google earth.
calc_footprint_FFP_climatology (computes area graphs)
After filtering out the fluxes, use the subset in this to get the images of the flux footprints for creating maps.
Any real subset (recommend that it is filtered first) can be put into here so its pretty flexible (Time of year or something)

## Formulas

Calculate the upwind area aka footprint ($X_f$, m) representative of these measurements that accounts for a percentage of the flux. Where $U$ is the assumed constant wind speed, $u^{*}$ is the friction velocity, $d$ is the displacement height due to vegetation (taken as 2/3 the vegetation height), $z$ is the instrument height, $k$ is the von karmans constant (usually taken as 0.4), $f$ is the fraction of the area that explains the flux [@Schuepp1990]:

$$
X_f = - \frac{1}{ln(f)}\frac{U}{u^*}\frac{z-d}{k}
$$ 

Friction velocity ($u_*$) can be modelled as in wind_profile.Rmd or is also measured at the Eddy Covariance Sites. 

## find the parameters $u^{âˆ—}$, $Z_{0m}$, and $d_0$ of the logarithmic wind profile equation that best matches the measured data provided below:

Constants:

```{r}
high_tower_ec_height <- 15 # m TODO should this change with snowpack?
low_tower_ec_height <- c(2,3) # Feb 17, 2022 Tower raised at 5 pm Feb 17 (MST) aka 6 pm CDT / MDT
low_tower_raised_dt <- as.POSIXct('2022-02-17 18:00:00', tz = 'Etc/GMT+6')

ec_dir_offset_mag <- 124 # offset to add to get to true north datum
calg_declination <- 13.5 # deg. west declination to convert magnetic direction to true north by adding this

k <- 0.4 # von karmans constant (unitless) 

tree_heights <- readRDS('../lidar/data/22_243_FT_ttops_5m_norm.rds')
mean_height <- mean(tree_heights$Z)

f <- 0.85 # If you wish to know the length scale of the footprint where 85% of the flux is originating from, then f=0.85

# displacement height found using iterative method from estimate_roughness_displacement.rds

low_d_0 <- readRDS('data/event_average_z_0m_d0_low_tower.rds')$event_d_0
high_d_0 <- readRDS('data/event_average_z_0m_d0_high_tower.rds')$event_d_0

d_0_est_t_height <- (2/3)*mean_height

```

Load Data: 

```{r}

ffr_snow_depth <- readRDS('../met-data-processing/data/ffr_met_main_qaqc.rds') |> 
  select(datetime, SnowDepth) |> 
  mutate(SnowDepthFill = imputeTS::na_interpolation(SnowDepth, maxgap = 4*6))

low_wind <- readRDS('data/low-tower/low_tower_15min_2021_2023_qc_rough.rds') |> select(datetime, wnd_dir_compass = wind_dir_mag, u_star, wind = wind_speed) |> 
  mutate(wind_dir = (wnd_dir_compass + ec_dir_offset_mag) %% 360,
         inst_height = case_when(
           datetime < low_tower_raised_dt ~ 2,
           datetime >= low_tower_raised_dt ~ 3
         )) |> 
  select(-wnd_dir_compass)

mid_wind <- readRDS('../../analysis/met-data-processing/data/ffr_met_main.rds') |> select(datetime, US_WindSpeed_avg) 

hi_wind <- readRDS('data/high-tower/ec_high_tower_30_min_2021_2023_qc_rough.rds') |> select(datetime, wnd_dir_compass = wind_dir_mag, u_star, wind = wind_speed) |> 
  mutate(wind_dir = wnd_dir_compass + calg_declination,
         inst_height = 15) |> 
  select(-wnd_dir_compass)

all <- rbind(low_wind, hi_wind)

all <- weatherdash::cat_wind(all, 'wind_dir', 'wind_dir_bin')

# ggplot(all, aes(datetime, wind)) + 
#   geom_point() +
#   facet_wrap(~inst_height)
# plotly::ggplotly()
  
#|> filter(as.Date(datetime) == as.Date('2022-01-16')) 

to_long_dates <- function(from, to, storm_id){
  date <- seq(from, to, 'day')
  
  out <- data.frame(date, storm_id)
  
  return(out)
}

# good EC periods where the upper and lower systems are producing data
# the lower ec system was checked prior to the start of each period

good_ec_star_end <- read.csv('data/clean_ec_events.csv') |> 
  mutate(
    from = as.Date(from, tz = 'Etc/GMT+6'),
    to = as.Date(to, tz = 'Etc/GMT+6'),
    storm_id = from)

good_ec_periods <-
  purrr::pmap_dfr(good_ec_star_end |> select(c(from, to, storm_id)), to_long_dates)

```

Calculate $X_f$:

```{r}
x_f <- all |> 
  mutate(x_f = -(1/log(f))*(wind/u_star)*((inst_height-low_d_0)/k)) |> 
  filter(x_f < 5000)

```

Plot $X_f$ for 3m EC with wind speed on all days: 
NOTE EC WAS RAISED Feb 17, 2022, this could be why relationship changes after FEB plot.

```{r}
ggplot(x_f |> filter(inst_height == 3), aes(wind, x_f, colour = wind_dir_bin)) +
  geom_point() +
  facet_wrap(~strftime(as.Date(datetime), "%m"))
```

```{r}
ggplot(x_f |> filter(inst_height == 3), aes(wind, x_f, colour = strftime(as.Date(datetime), "%m"))) +
  geom_point() +
  facet_wrap(~wind_dir_bin)
```

Plot $X_f$ for 15 m EC with wind speed on all days: 

Maybe larger footprint during winter months when snow is in the trees? 

```{r}
ggplot(x_f |> filter(inst_height == 15), aes(wind, x_f, colour = wind_dir_bin)) +
  geom_point() +
  facet_wrap(~strftime(as.Date(datetime), "%m"), scales = 'free')
```
```{r}
ggplot(x_f |> filter(inst_height == 15), aes(wind, x_f, colour = strftime(as.Date(datetime), "%m"))) +
  geom_point() +
  facet_wrap(~wind_dir_bin)
```

Output $X_f$ table

```{r}
x_f_summary <- x_f |> 
  mutate(yr_mon =  strftime(as.Date(datetime), "%y-%m")) |> 
  group_by(inst_height, yr_mon) |> 
  summarise(x_f_mean = mean(x_f, na.rm = T),
            u_star_mean = mean(u_star, na.rm = T),
            wind_spd_mean = mean(wind, na.rm = T),
            wind_spd_pk_mean = max(wind, na.rm = T),
            wind_dir_mean = mean(wind_dir, na.rm = T))
x_f_summary

write.csv(x_f_summary, 'data/ec_footprint_summary.csv')

```


Wind Rose for all months for each instrument height:

```{r}
# for (i in c(3,13.5)) {
#   for (m in 1:12) {
#     fltr <- all |> 
#       mutate(month = as.numeric(strftime(as.Date(datetime), "%m"))) |> 
#       filter(inst_height == i,
#              month == m)
#     
#   if(nrow(fltr) != 0){
#     p <- weatherdash::wind_rose(fltr, 'datetime', 'wind', 'wind_dir', plot_title = paste('Height', i, "m", 'for', m))
#     file1 <- paste0('figs/wind_rose/wind_rose_height_', i, '_', m,'.html')
#     file2 <- paste0('figs/wind_rose/wind_rose_height_', i, '_', m,'.png')
# 
#     htmlwidgets::saveWidget(plotly::as_widget(p), file1)
#     plotly::save_image(p, file2)
#   }
# 
#   }
#   
# }
```

Look at one of the windiest days without snow on instruments:

```{r}
ggplot(x_f |> filter(as.Date(datetime) == as.Date('2022-01-16')) , aes(wind, x_f)) +
  geom_point() +
  facet_wrap(~inst_height, scales = 'free')
```

Wind Rose on this Day:

```{r}

ggplot(low_wind, aes(datetime, wind)) + 
  geom_point() 

weatherdash::wind_rose(low_wind, 'datetime', 'wind', 'wind_dir', plot_title = 'test')
```

